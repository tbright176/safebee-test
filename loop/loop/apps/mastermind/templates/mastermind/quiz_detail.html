{% extends "content.html" %}
{% load render_rail %}

{% block default_css_bottom %}
<link rel="stylesheet" href="{{ STATIC_URL }}css/animate.min.css">
{% endblock %}

{% block content %}

<div class="row full-width-mobile">
  <div class="small-12 medium-9 columns">
    <div id="quiz-container">
      {% include 'mastermind/background_image.html' with image=content_item.primary_image.asset %}
      <div id="quiz">
        <div id="quiz-content">
          <form id="question-form">
            {% csrf_token %}
            <h1>{{ content_item.title }}</h1>
            <p>{{ content_item.description }}</p>
            <button type="submit" name="btn-quiz" value="first">START THE QUIZ &nbsp;<i class="fa fa-caret-right"></i></button>
          </form>
        </div>
      </div>
    </div>
  </div>
  <div class="medium-3 columns rail show-for-medium-up">
    {% render_rail request.path %}
  </div>
</div>

<div class="row quiz-comments">
  <div class="small-12 medium-9 columns">
    {% if not content_item.disable_comments %}{% include 'comments.html' %}{% else %}<p>Comments are disabled for this page.</p>{% endif %}
  </div>
  <div class="medium-3 show-for-medium-up columns"></div>
</div>

<div id="questions-container" class="hide">
  {% for question in questions %}
    <div id="question-{{ question.id }}">
      {% include 'mastermind/question_detail.html' %}
    </div>
  {% endfor %}
</div>

<div id="answers-container" class="hide"></div>

<div id="quiz-results" class="hide">
    {% include 'mastermind/player_results.html' %}
</div>

{% endblock %}

{% block extra_js_bottom %}
<script>

$(document).ready(function() {

    {% comment %} load score ranges into quiz-container {% endcomment %}
    var score_ranges = []

    {% for score_range in content_item.scorerange_set.all %}
    score_ranges.push({"lower": {{ score_range.lower_limit }},
                       "upper": {{ score_range.upper_limit }},
                       "text": "{{ score_range.text }}"});
    {% endfor %}

    $('#quiz-container').data('score_ranges', score_ranges);

    {% comment %} process an answer choice {% endcomment %}
    $('#quiz-container').on('click', ':radio', function(event) {
        var correct_span = $('#quiz-container .explanation>span');
        if ($(this).data('correct') == 'True') {
            correct_span.addClass('correct');
            correct_span.html('Correct!');
        } else {
            correct_span.addClass('incorrect');
            correct_span.html('Incorrect.');
        };
        $('#quiz-container .explanation').removeClass('hide');
        $('#quiz-container input:radio').attr('disabled', true);
        $('button[name="btn-quiz"]').removeClass('disabled');
    });

    {% comment %}
    check for a response, the correctness, and then load the next question or results
    {% endcomment %}
    $('#quiz-container').on('click', 'button[name=\'btn-quiz\']', function(event) {
        event.preventDefault();
        var btn_value = $(this)[0].value;
        var has_response = false;

        if (btn_value == 'next') {
            response = $('#quiz-container :checked');
            if (response.length) {
                has_response = true;
                response.clone().appendTo('#answers-container');
            };
        };

        if (has_response || (btn_value == 'first')) {
            var next_question = $('#questions-container > :first-child');
            if (next_question.length) {
                $('#quiz-content').children().addClass('animated fadeOutLeft');
                $('#quiz-content').children().first().one('webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend', function () {
                    $('button[name="btn-quiz"]').addClass('disabled');
                    $('#quiz-container').html(next_question.html());
                    $('#quiz-content').children().addClass('animated fadeInRight');
                    next_question.remove();
                });
            } else {
                var num_correct = 0;
                $('#answers-container :input').each(function () {
                    if ($(this).data('correct') == 'True') {
                        num_correct++;
                    }
                });
                $('#results-num-correct').html(num_correct);
                $.each($('#quiz-container').data('score_ranges'), function (index, value) {
                    if ((value['lower'] <= num_correct) && (num_correct <= value['upper'])) {
                        $('#results-text .score-range-text>span').html(value['text']);
                    }
                });
                $('#quiz-content').children().addClass('animated fadeOutLeft');
                $('#quiz-content').children().first().one('webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend', function () {
                    $('button[name="btn-quiz"]').addClass('disabled');
                    $('#quiz-container').html($('#quiz-results').html());
                    $('#quiz-content').children().addClass('animated fadeIn');
                });
            };
            ga('send', 'pageview');
        };
    });
});

</script>
{% endblock %}
